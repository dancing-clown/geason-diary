# 期货交易

## 期货定义

期货(Futures)是约定未来某一时间以特定价格买卖加密货币的合约。核心作用是对冲风险或杠杆投机。

按合约周期分为永续合约和交割合约。

## 撮合机制

### 集合竞价

集合竞价撮合成交：指对在规定时间内接受的买卖申报指令一次性集中撮合的竞价方式。采用最大成交量原则，即以此价格成交能够得到最大成交量。

具体是前四分钟为期货合约买卖指令申报，后一分钟为集合竞价撮合。

开盘集合竞价产生的成交价作为成交价格作为开盘价。开盘集合竞价未产生成交价的，以开市后竞价交易的第一笔成交作为开盘价。

高于开盘价的买入申报全部成交，低于开盘价卖出申报全部成交。开盘集合竞价中的未成交申报单自动参与开市后竞价交易。

对于夜盘未成交订单

大连商品交易所、上海期货交易所、上海国际能源交易中心：自动参与日盘集合竞价，可在上午8:55-8:59取消委托或者改价重新委托。

夜盘未成交订单处理

郑州商品交易所：自动参与连续竞价，可在上午8:55-8:59取消委托。

中国金融期货交易所、广州期货交易所：无夜盘交易。

### 连续竞价

连续竞价是指买卖申报指令逐笔撮合的竞价方式，交易所撮合原则为价格优先，时间优先。价格优先即较高价买入申报优于较低价格买入申报，较低价格卖出申报优于较高价格卖出申报；时间优先即买卖方向，价格相同的，先申报的优先于后申报的，先后顺序按交易系统接受申报的时间确定。

traded_price = mid(buy_price, sell_price, last_traded_price)

而buy_price >= sell_price才会撮合，所以就是根据last_trade_price的位置分为三种情况

## 订单类型

目前国内市场的订单类型分为市价单(Market Order)和限价单(Limit Order)。如果是加密货币市场还有止损单(Stop Loss Order)和止盈单(Take Profit Order)。

限价单：用户指定成交价格。

市价单：用户不指定价格，按当前市场最优可成交价格（最快成交+对用户最有利价格）立即成交，即从订单薄优先匹配对当前用户成本最低/收益最高的对手方订单，优先级会低于限价单。

交易所的订单簿（Order Book）会实时维护两类订单：
买单（Bid）：所有用户愿意买入的价格（按从高到低排序，比如 100 、99.9 、99.8 ...）；
卖单（Ask）：所有用户愿意卖出的价格（按从低到高排序，比如 100.1 、100.2 、100.3 ...）；
关键：买单的最高价格（买一）和卖单的最低价格（卖一）是 “当前市场最优价格”，也是市价单优先匹配的对象。

|用户操作|最优可成交价格是什么|核心逻辑|
|---|---|---|
|用户挂 “市价买单”|订单簿中 最低的卖单价格（卖一价，比如 100.1）|对买方来说，买价越低越有利，所以优先匹配最便宜的卖单，保证成本最低 + 立即成交|
|用户挂 “市价卖单”|订单簿中 最高的买单价格（买一价，比如 100）|对卖方来说，卖价越高越有利，所以优先匹配最昂贵的买单，保证收益最高 + 立即成交|

滑点：如果订单薄中的最优价格的对手方订单不足以完成成交，撮合引擎会继续匹配次优价格，此时会产生"滑点"。（买入市价量大，匹配完卖一继续匹配卖二，最终订单成交的价格介于卖1和卖2之间，成交价格 - 卖1价格 = 滑点）。

止损/止盈单：触发条件满足后，自动转为限价单/市价单（开多止损，当价格低于止损价时，挂市价单可以及时成交止损）。

## 订单有效期

IOC(Immediate Or Cancel)：立即完成，否则撤销。

GFD(Good For Day): 当日有效。

GTC(Good Till Cancel)：直到取消或成交。

GTA(Good Till Auction): 集合竞价有效。

## 撮合流程总结

1. 接收用户订单（验证签名、资金充足性）；
2. 按订单类型加入对应订单簿（买单簿/卖单簿，按价格排序，同价格按时间排序）；
3. 尝试匹配：新挂买单 ↔ 卖单簿中最低卖价（≤ 买单价格），新挂卖单 ↔ 买单簿中最高买价（≥ 卖单价格）；
4. 匹配成功：生成成交记录（trade record），更新用户持仓、保证金、可用资金；
5. 匹配失败：订单留在订单簿中，等待后续市场价格触发。

## 保证金与爆仓机制

初始保证金：开仓时必须缴纳的最低资金（比如10x， 初始保证金10%， 用户买10000，则缴纳保证金1000）

维持保证金：持仓期间必须维持的最低保证金（通常低于初始保证金，8%）

爆仓逻辑：当用户持仓亏损导致保证金余额<=维持保证金时，系统触发“强制平仓”；

爆仓流程：系统自动以市场价卖出用户持仓，偿还交易所借款（杠杆部分）。

风险点：若市场流动性不足，平仓可能低于预期，导致用户保证金全部亏损完仍欠交易所资金（穿仓），需要设计“风险准备金”机制兜底，或提前设置强平价格预警。

## 系统设计核心特性

定义：资金、订单、持仓的状态必须实时同步，无歧义（比如用户挂单后，可用资金必须立即冻结，避免超仓；成交后，持仓必须立即更新，不能出现“成交了单持仓没变化”的情况）。

ctp对应于long_frozen, short_frozen。

yida对应于open_frozen, close_frozen。
